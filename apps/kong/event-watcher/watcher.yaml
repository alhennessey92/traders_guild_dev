apiVersion: v1
kind: Pod
metadata:
  name: event-watcher
  namespace: kube-system
spec:
  serviceAccountName: event-watcher-sa  # <-- Set the correct ServiceAccount
  containers:
    - name: kubectl
      image: bitnami/kubectl:latest
      command:
        - /bin/sh
        - -c
        - |
          while true; do
              kubectl get events -n kube-system --watch | while read event
              do
                  if echo "$event" | grep -q "ScalingNodePool"; then
                      if echo "$event" | grep -q "ScalingDown"; then
                          echo "Scaling down detected, deleting Kong LoadBalancer..."
                          kubectl delete svc kong-proxy -n kong
                          kubectl delete svc argocd-server -n argocd
                      elif echo "$event" | grep -q "ScalingUp"; then
                          echo "Scaling up detected, syncing Kong via ArgoCD..."
                          argocd app sync kong --grpc-web
                          argocd app sync argocd --grpc-web
                      fi
                  fi
              done
              sleep 5
          done